# Resumo da Aula: Integração de Feature Flags com uma Aplicação Node.js no Unleash

## Introdução
Nesta aula, o professor demonstra a integração prática do Unleash com uma aplicação Node.js simples, mostrando como consumir Feature Flags em um ambiente real. O foco é configurar um projeto Node.js, instalar o client do Unleash, criar uma conexão com o servidor Unleash e testar o comportamento de uma flag (`login_page`) com diferentes configurações, incluindo rollout gradual e controle por sessão. A aula reforça a aplicação prática dos conceitos teóricos abordados anteriormente.

## Conteúdo Principal

### Configuração do Projeto Node.js
- **Inicialização**: O professor cria um projeto Node.js chamado `unleash-demo` usando `yarn init` dentro de uma pasta específica. Um arquivo `index.js` é criado para escrever o código de teste.
- **Instalação do Client**: A biblioteca `@unleash/client` é instalada via `yarn add @unleash/client` para facilitar a comunicação com o Unleash. Alternativamente, chamadas diretas à API (`/api`) são possíveis, mas menos práticas.
- **Estrutura do Código**:
  - O código importa a função `initialize` do client Unleash e cria uma instância com as configurações:
    - **URL**: `http://127.0.0.1:4242/api` (a porta do Unleash, ajustada localmente).
    - **AppName**: `unleash-demo` (identifica a aplicação).
    - **Authorization**: Um token de API é necessário para autenticação.
  - Uma função `verifyToggles` usa `unleash.isEnabled` para verificar o estado da flag `login_page` e exibe o resultado (`true` ou `false`) no console.

### Configuração do Token de API
- **Acesso ao Token**:
  - No Unleash, na seção **Admin Settings > Access Control**, o professor cria um token de API chamado `app-unleash-demo` para o ambiente `development` e projeto `default` (ou asterisco para todos os projetos na versão open-source).
  - O token é configurado como **Back-end SDK**, já que a aplicação é um back-end Node.js. Tokens para front-end têm considerações de segurança adicionais devido à exposição em navegadores.
  - O token tem o formato `*:development.<token>`, onde o asterisco indica todos os projetos (na versão open-source, apenas `default` está disponível).
- **Boa Prática**: O token deve ser armazenado em variáveis de ambiente (`env var`) em produção, não diretamente no código, para maior segurança.

### Testes com a Feature Flag
- **Teste Inicial**:
  - A flag `login_page` é testada com o método `unleash.isEnabled`. Inicialmente, retorna `false` devido a um nome de flag incorreto (`flag_name`). Após corrigir para `login_page`, o teste reflete o estado da flag no Unleash.
  - O Unleash pode levar de 1 a 2 minutos para propagar mudanças (ex.: ativar/desativar a flag), o que é uma boa prática a ser considerada em cenários reais.
- **Comportamento com Standard Strategy**:
  - Com a flag configurada como **Standard** (ativa para 100% da base), o código retorna `true` quando ativada e `false` quando desativada, com os resultados refletidos quase imediatamente após a propagação.
- **Teste com Gradual Rollout**:
  - A estratégia é alterada para **Gradual Rollout** com 50% de ativação. O Unleash retorna `true` para aproximadamente 50% das requisições e `false` para as demais, demonstrando o comportamento aleatório.
  - O professor adiciona um `setInterval` para chamar `verifyToggles` a cada 3 segundos, mostrando a alternância entre `true` e `false` em tempo real.
- **Controle por Sessão**:
  - Configurando o rollout com **Session ID**, o Unleash garante que a mesma sessão receba o mesmo resultado (`true` ou `false`), mantendo consistência para o usuário.
  - Testes com 90% de rollout mostram que a maioria das requisições retorna `true`, com poucos `false`, refletindo a proporção configurada.

### Observações e Boas Práticas
- **Propagação de Mudanças**: Alterações no Unleash (ex.: ativar/desativar flags ou mudar porcentagens) podem levar alguns minutos para serem refletidas, especialmente em cenários de produção.
- **Eventos do Client**: O código usa o evento `ready` do Unleash para garantir que a instância esteja pronta antes de verificar flags. Outros eventos, como `error`, podem ser usados para monitoramento.
- **Flexibilidade**: O Unleash permite alternar estratégias dinamicamente (Standard, Gradual Rollout, Session ID) sem alterar o código da aplicação, delegando o controle ao vendor.

### Próximos Passos
- A próxima aula abordará **constraints** (segmentação por campos como `userId` ou `groupId`) e **variantes**, explorando configurações mais avançadas do Unleash e sua integração com a aplicação.

## Conclusão
A aula demonstra a integração prática do Unleash com uma aplicação Node.js, mostrando como configurar um client, autenticar com um token de API e testar o comportamento de uma Feature Flag em diferentes cenários (Standard e Gradual Rollout). O uso de `setInterval` e a configuração de Session ID ilustram a flexibilidade do Unleash em gerenciar ativação de funcionalidades. A aula reforça a importância de boas práticas, como armazenar tokens em variáveis de ambiente e considerar o tempo de propagação de mudanças, preparando o aluno para explorar configurações mais avançadas na próxima aula.