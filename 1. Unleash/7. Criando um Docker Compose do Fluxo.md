# Resumo da Aula: Configuração de Variantes com Constraints e Docker Compose no Unleash

## Introdução
Nesta aula, o professor conclui a exploração prática do Unleash, combinando **variantes** com **constraints** e configurando um **Docker Compose** para simplificar a execução do ambiente (Unleash e PostgreSQL). O foco é testar a flag `login_page` com constraints baseadas em `groupId` e variantes, além de reforçar boas práticas, como o uso do **Docker Compose** e a ativação de **Impression Data**. A aula também introduz o conceito de **Open Feature**, que será abordado na próxima aula como uma abordagem para desacoplar a aplicação do vendor.

## Conteúdo Principal

### Variantes com Constraints
- **Configuração no Unleash**:
  - A flag `login_page` é configurada com uma estratégia de **Gradual Rollout** (inicialmente 50%, depois ajustada para 100%) e uma **constraint** baseada no campo `groupId` com valor `RocketseatUser`.
  - Duas variantes são definidas:
    - Variante A: Nome "A", valor "logar".
    - Variante B: Nome "B", valor "entrar".
  - O rollout de 50% significa que 50% dos usuários com `groupId: RocketseatUser` verão a flag ativa, divididos igualmente entre as variantes A e B (25% cada). Com 100% de rollout, todos os usuários com `groupId: RocketseatUser` verão a flag ativa, alternando entre A e B.
- **Teste na Aplicação**:
  - O código Node.js passa o contexto `{ properties: { groupId: 'RocketseatUser' } }` na chamada `unleash.isEnabled('login_page', context)`.
  - Resultados:
    - Com `groupId: RocketseatUser`, a flag retorna `true` com variantes alternando entre "logar" e "entrar".
    - Com `groupId: RocketseatUserOld`, retorna `false`, respeitando a constraint.
  - A alternância entre `true` e `false` (com rollout de 50%) e entre variantes A e B demonstra o controle granular do Unleash.

### Configuração do Docker Compose
- **Motivação**: Configurar o Unleash e o PostgreSQL manualmente com `docker run` é trabalhoso. O **Docker Compose** simplifica a execução e manutenção do ambiente.
- **Arquivo `docker-compose.yml`**:
  ```yaml
  version: '3.8'
  services:
    postgres:
      image: postgres:latest
      container_name: postgres_unleash
      environment:
        - POSTGRES_USER=unleash_user
        - POSTGRES_PASSWORD=unleash
        - POSTGRES_DB=unleash_db
      networks:
        - unleash
    unleash:
      image: unleashorg/unleash-server:latest
      container_name: unleash
      ports:
        - "4200:4242"
      environment:
        - DATABASE_HOST=postgres_unleash
        - DATABASE_NAME=unleash_db
        - DATABASE_USERNAME=unleash_user
        - DATABASE_PASSWORD=unleash
        - DATABASE_SSL=false
      depends_on:
        - postgres
      networks:
        - unleash
  networks:
    unleash:
  ```
- **Explicação**:
  - **Postgres**: Usa a imagem `postgres:latest`, com variáveis de ambiente para usuário, senha e nome do banco.
  - **Unleash**: Usa a imagem `unleashorg/unleash-server:latest`, mapeia a porta 4200 (host) para 4242 (container) e conecta ao PostgreSQL via variáveis de ambiente. A opção `depends_on` garante que o PostgreSQL inicie antes do Unleash.
  - **Rede**: Ambos os serviços rodam na rede isolada `unleash` para comunicação interna.
- **Execução**:
  - O professor limpa containers e imagens existentes (`docker system prune`, `docker rm -f`) para evitar conflitos.
  - Executa `docker compose up`, confirmando que o Unleash e o PostgreSQL iniciam corretamente.
  - A interface do Unleash é acessada em `localhost:4200` com credenciais padrão (`admin/unleash4all`).

### Teste Final
- **Recriação da Flag**:
  - Como o ambiente foi reiniciado sem volumes, os dados anteriores foram perdidos (efemeridade). O professor recria a flag `login_page` com:
    - Tipo: **Release**.
    - **Impression Data**: Ativado para coletar métricas.
    - Campo customizado: `groupId` com valor `RocketseatUser`.
    - Estratégia: **Gradual Rollout** com variantes A ("logar") e B ("entrar").
  - Um novo token de API é gerado para o projeto `default` e ambiente `development` (`default:development.<token>`), usado na aplicação Node.js.
- **Resultados**:
  - A aplicação Node.js retorna `true` para `groupId: RocketseatUser`, alternando entre as variantes "logar" e "entrar", conforme configurado.
  - O comportamento é consistente com a estratégia definida, validando a configuração do Docker Compose e da flag.

### Boas Práticas e Observações
- **Initialize vs. StartUnleash**:
  - `initialize` (usado na aplicação) não é uma promessa, enquanto `startUnleash` é. Em produção, `startUnleash` deve ser usado no bootstrap da aplicação para garantir inicialização assíncrona e desempenho otimizado.
  - Um erro inicial ocorre devido ao uso incorreto de `startUnleash` sem aguardar a promessa, mas o professor mantém `initialize` para simplicidade.
- **Volumes**: Para evitar perda de dados (como flags e configurações), volumes devem ser configurados no Docker Compose em ambientes reais.
- **Impression Data**: Ativar essa opção permite rastrear chamadas à flag, úteis para análise de desempenho e conversão.
- **Constraints com Variantes**: Combinar constraints com variantes permite segmentação granular (ex.: apenas um grupo vê a funcionalidade) com personalização (ex.: diferentes labels por variante).

### Próximos Passos
- A próxima aula abordará o **Open Feature**, um padrão inspirado no OpenTelemetry que desacopla a aplicação do vendor (Unleash), permitindo maior flexibilidade e portabilidade. A base prática estabelecida com o Unleash será usada para explorar essa abordagem.

## Conclusão
A aula consolida o uso de **variantes** com **constraints** no Unleash, demonstrando como combinar segmentação por `groupId` com personalização de features. A configuração do **Docker Compose** simplifica a gestão do ambiente, enquanto testes práticos na aplicação Node.js validam o comportamento das flags. A introdução ao **Open Feature** promete uma abordagem mais abstrata para gerenciar Feature Flags, aproveitando a base prática já construída. A aula reforça boas práticas, como o uso de volumes e a inicialização correta do client, preparando o aluno para cenários mais avançados.