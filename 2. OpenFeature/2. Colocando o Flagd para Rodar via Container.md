# Resumo da Aula: Configuração do FlagD e Integração com Open Feature

## Introdução
Nesta aula, o professor avança na configuração do **FlagD**, um provedor do **Open Feature**, explorando sua principal diferença em relação ao **Unleash**: o uso de arquivos JSON como fonte de verdade para definições de Feature Flags, em vez de uma interface gráfica. O foco é configurar o FlagD via Docker, criar um arquivo de flags (`flags.json`) e preparar a aplicação Node.js para consumir essas flags, ajustando a porta de conexão. A aula também destaca o comportamento de sincronização do FlagD e prepara para a integração completa na próxima aula.

## Conteúdo Principal

### Diferenças entre FlagD e Unleash
- **Abordagem do FlagD**:
  - Diferentemente do Unleash, que usa uma UI administrativa para gerenciar flags, o FlagD armazena as definições de Feature Flags em arquivos JSON, que servem como a fonte da verdade.
  - O arquivo JSON segue um esquema específico, contendo informações como estado da flag (`enabled` ou `disabled`), variantes e regras de segmentação.
  - O FlagD não possui uma interface gráfica por padrão, mas oferece um **playground** (no site `flagd.dev`) para testar definições de flags antes de aplicá-las.
- **Sincronização**:
  - O FlagD suporta sincronização automática: alterações no arquivo JSON (ex.: `flags.json`) são detectadas e refletidas em tempo real, facilitando testes.

### Configuração do Arquivo `flags.json`
- **Estrutura do Arquivo**:
  - O professor cria um arquivo `flags.json` no projeto `flagd-demo`, replicando a flag `login_page` usada no Unleash:
    ```json
    {
      "$schema": "https://flagd.dev/schema/v0/flags.json",
      "flags": {
        "loginPage": {
          "state": "ENABLED",
          "variants": {
            "A": "logar",
            "B": "entrar"
          },
          "defaultVariant": "A"
        }
      }
    }
    ```
  - **Explicação**:
    - **`$schema`**: Opcional, mas boa prática, referencia o esquema JSON do FlagD.
    - **`flags`**: Contém as definições das flags, com `loginPage` como exemplo.
    - **`state`**: Define se a flag está ativa (`ENABLED`) ou desativada (`DISABLED`).
    - **`variants`**: Define as variantes `A` ("logar") e `B` ("entrar").
    - **`defaultVariant`**: Define a variante padrão (`A`, retornando "logar") quando a flag está ativa.
- **Comparação com Unleash**: O arquivo JSON substitui a configuração via UI do Unleash, oferecendo uma abordagem mais declarativa, mas menos visual.

### Configuração do FlagD via Docker
- **Comando Docker**:
  - O professor executa o FlagD com o seguinte comando:
    ```bash
    docker run -it -p 8014:8013 -v $(pwd)/flags.json:/etc/flagd/flags.json ghcr.io/openfeature/flagd:latest start --uri file:/etc/flagd/flags.json
    ```
  - **Explicação**:
    - **`-it`**: Modo interativo para visualizar logs.
    - **`-p 8014:8013`**: Mapeia a porta 8013 (padrão do FlagD para gRPC) para 8014 no host.
    - **`-v $(pwd)/flags.json:/etc/flagd/flags.json`**: Monta o arquivo `flags.json` local no diretório `/etc/flagd/` dentro do container.
    - **`ghcr.io/openfeature/flagd:latest`**: Imagem oficial do FlagD, obtida do GitHub Container Registry.
    - **`start --uri file:/etc/flagd/flags.json`**: Inicia o FlagD e aponta para o arquivo de flags no container.
  - **Alternativas**:
    - O arquivo de flags pode estar em um bucket S3 ou outro local acessível via HTTP, usando `--uri http://<url>`.
    - A porta 8014 ou 8015 pode ser usada para HTTP, mas gRPC (porta 8013) é o padrão.
- **Sincronização**:
  - Alterações no `flags.json` (ex.: salvar o arquivo) disparam um resync automático, atualizando as flags sem reiniciar o container.

### Ajuste na Aplicação Node.js
- **Código**:
  - O código no `index.js` é ajustado para conectar ao FlagD na porta correta:
    ```javascript
    import * as OpenFeature from '@openfeature/server-sdk';
    import { FlagdProvider } from '@openfeature/flagd-provider';

    const flagdProvider = new FlagdProvider({ host: '127.0.0.1', port: 8014 });

    (async () => {
      await OpenFeature.setProvider(flagdProvider);
      const client = await OpenFeature.getClient();
    })();
    ```
  - **Mudança**: A porta é alterada de 8013 (padrão) para 8014, correspondendo ao mapeamento no comando Docker.
- **Teste**:
  - Ao rodar `node index.js`, o erro de conexão desaparece, indicando que a aplicação se conectou ao FlagD. No entanto, a leitura da flag ainda não foi implementada.

### Playground do FlagD
- **Funcionalidade**: O site `flagd.dev` oferece um playground para testar definições de flags JSON, verificando se retornam os valores esperados com base em contextos (ex.: `age > 18`).
  - Exemplo: Um contexto com `age: 20` retorna `true`, enquanto `age: 15` retorna `false`.
- **Utilidade**: Permite validar a lógica das flags antes de integrá-las à aplicação, compensando a ausência de uma UI.

### Próximos Passos
- A próxima aula completará a configuração da aplicação Node.js para consumir a flag `loginPage` do `flags.json`, testando seu comportamento (ex.: retorno de "logar" ou "entrar") e explorando regras de segmentação e variantes.

## Conclusão
A aula destaca a abordagem baseada em arquivos do **FlagD**, contrastando com a UI do **Unleash**, e configura o ambiente com Docker para rodar o FlagD e mapear o arquivo `flags.json`. A integração inicial com o **Open Feature** é estabelecida, ajustando a porta de conexão, e o playground do FlagD é apresentado como uma ferramenta de validação. A sincronização automática do FlagD e a flexibilidade do Open Feature reforçam sua adequação para cenários que exigem desacoplamento. A aula prepara para a implementação completa da leitura de flags na aplicação Node.js.